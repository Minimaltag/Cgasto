<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ffffff">
  <title>Cgasto</title>    
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --danger:#ef4444;
      --border:1px solid rgba(148,163,184,.2);
      --radius:18px;
    }
    @media (prefers-color-scheme: light){
      :root{ 
        --bg:#f8fafc; 
        --card:#ffffff; 
        --muted:#64748b; 
        --text:#0f172a; 
        --border:1px solid rgba(100,116,139,.3);
      } 
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";}
    .wrap{max-width:720px;margin:0 auto;padding:16px;padding-bottom:24vh;}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg) 40%,transparent);}
    .title{display:flex;align-items:center;gap:10px;padding:8px 4px 10px}
    .logo{width:34px;height:34px;border-radius:12px;background:var(--card);display:grid;place-items:center;border:var(--border);}
    .logo b{font-weight:800}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;border:var(--border);position:relative;}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted)}
    input, button{width:100%;padding:14px 12px;border-radius:14px;border:1px solid var(--muted);background:transparent;color:var(--text);}
    input::placeholder{color:var(--muted)}
    label{font-size:12px;color:var(--muted)}
    button.primary{background:var(--accent);color:#062a15;font-weight:700}
    button.ghost{background:transparent;border:1px dashed rgba(148,163,184,.35)}
    button.danger{background:var(--danger);color:#fff}
    button:active{transform:translateY(1px)}
    .row{display:flex;align-items:center;gap:10px}
    .totals{display:flex;align-items:baseline;justify-content:space-between;padding:4px 2px;margin-top:4px}
    .total-valor{font-size:28px;font-weight:800}
    .list{display:grid;gap:10px;margin-top:12px}
    .item{display:flex;gap:12px;align-items:center;background:var(--card);border:var(--border);padding:12px;border-radius:16px}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid; color:var(--danger); background:transparent;}
    .badge.paid{border-color:var(--accent); color:var(--accent);}
    .grow{flex:1}
    .amount{font-weight:800; color:var(--danger);}
    .amount.paid{color:var(--accent);}
    .item .actions{display:flex;gap:6px}
    .btn-circle{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid var(--muted);background:transparent;cursor:pointer;padding:0;}
    .btn-circle svg{width:18px;height:18px;stroke-width:2;stroke:currentColor;}
    .empty{border:1px dashed rgba(148,163,184,.35);padding:18px;border-radius:16px;text-align:center}
    h2.month-title {text-align:center;font-size:16px;font-weight:700;color:var(--text);margin:0;padding:8px 0;}

    /* Botão flutuante */
    .fab {position:absolute;bottom:14px;right:14px;}
    .fab-btn {width:56px;height:56px;border-radius:50%;background:var(--accent);color:#062a15;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;font-size:28px;transition:transform 0.1s ease;}
    .fab-btn:active { transform:scale(0.95); }
    .fab-btn svg { width:28px; height:28px; }

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:100;}
    .modal{background:var(--card);padding:20px;border-radius:var(--radius);width:90%;max-width:400px;display:grid;gap:12px;border:var(--border);}
    .modal h2{margin:0;font-size:18px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo"><b>R$</b></div>
        <div>
          <h1>Gastos</h1>
          <div class="muted" id="subtitle">Controle simples e minimalista</div>
        </div>
      </div>
      <div class="card grid cols-2" style="align-items:end">
        <div>
          <label for="month">Mês</label>
          <input id="month" type="month" />
        </div>
        <div>
          <label for="search">Filtro</label>
          <input id="search" type="search" placeholder="categoria ou nota" />
        </div>
        <div class="totals" style="grid-column:1/-1">
          <div>
            <div class="muted">Total do mês</div>
            <div class="total-valor" id="total">R$ 0,00</div>
          </div>
        </div>
        <footer class="fab">
          <button id="addBtn" class="fab-btn" title="Adicionar gasto">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
            </svg>
          </button>
        </footer>
      </div>
    </header>

    <section style="margin-top:14px" class="grid">
      <h2 class="month-title" id="monthTitle">REFERENTE AO MÊS</h2>
      <div id="lista" class="list"></div>
    </section>
  </div>

  <template id="tpl-item">
    <div class="item" data-id="">
      <div class="grow">
        <div class="row" style="justify-content:space-between">
          <div class="amount"></div>
          <div class="muted date"></div>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:6px">
          <div class="muted info"></div>
          <span class="badge categoria"></span>
        </div>
      </div>
      <div class="actions">
        <button class="btn-circle edit" title="Editar">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536M4 20h4.586l10.828-10.828-4.586-4.586L4 15.414V20z" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button class="btn-circle del" title="Apagar">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button class="btn-circle pay" title="Pago">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </template>

  <!-- Modal adicionar gasto -->
  <div id="modalAdd" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h2>Novo gasto</h2>
      <label>Valor <input id="valor" type="number" step="0.01" placeholder="0,00" required></label>
      <label>Data <input id="data" type="date" required></label>
      <label>Categoria <input id="categoria" type="text" placeholder="ex.: mercado"></label>
      <label>Nota <input id="nota" type="text" placeholder="descrição"></label>
      <div class="actions">
        <button id="cancelAdd" class="ghost">Cancelar</button>
        <button id="saveAdd" class="primary">Adicionar</button>
      </div>
    </div>
  </div>

  <!-- Modal editar gasto -->
  <div id="modalWrap" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h2>Editar gasto</h2>
      <label>Valor <input id="editValor" type="number" step="0.01" /></label>
      <label>Data <input id="editData" type="date" /></label>
      <label>Categoria <input id="editCategoria" type="text" /></label>
      <label>Nota <input id="editNota" type="text" /></label>
      <div class="actions">
        <button id="cancelEdit" class="ghost">Cancelar</button>
        <button id="saveEdit" class="primary">Salvar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDd-i47C51sseWaMtZbBBdPbObjP1_kYzU",
      authDomain: "minimaltag-28769.firebaseapp.com",
      projectId: "minimaltag-28769",
      storageBucket: "minimaltag-28769.firebasestorage.app",
      messagingSenderId: "645337589970",
      appId: "1:645337589970:web:24be0fabbc3f2b30eaa50b"
    };

    const app = initializeApp(firebaseConfig);  
    const dbFire = getFirestore(app);  

    const $ = s => document.querySelector(s);
    const fmt = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const monthFmt = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' });

    const state = { items:[], month:'', search:'', editing:null };

    function today(){ return new Date().toISOString().slice(0,10); }
    function yyyymm(d){ return d.slice(0,7); }

    function formatMonthTitle(yyyymm) {
      const [year, month] = yyyymm.split('-');
      const date = new Date(year, month - 1);
      return `REFERENTE AO MÊS ${monthFmt.format(date).toUpperCase()}`;
    }

    function setMonthFromNow(){
      const m = yyyymm(today());
      state.month = m; $('#month').value = m;
    }

    async function add(item){
      try {
        const docRef = await addDoc(collection(dbFire, "gastos"), item);
        item.id = docRef.id;
      } catch(e){ console.warn("Erro salvar nuvem", e); }
      state.items.push(item);
      render();
    }

    async function remove(id){
      try { await deleteDoc(doc(dbFire, "gastos", id)); }
      catch(e){ console.warn("Erro remover nuvem", e); }
      state.items = state.items.filter(i=>i.id!==id);
      render();
    }

    async function update(id, patch){
      try { await updateDoc(doc(dbFire, "gastos", id), patch); }
      catch(e){ console.warn("Erro atualizar nuvem", e); }
      const i = state.items.findIndex(x=>x.id===id);
      if(i>-1){ state.items[i] = {...state.items[i], ...patch}; render(); }
    }

    function filtered(){
      const f = state.search.toLowerCase();
      return state.items
        .filter(i => yyyymm(i.data)===state.month)
        .filter(i => !f || (i.categoria?.toLowerCase().includes(f) || i.nota?.toLowerCase().includes(f)))
        .sort((a,b)=> b.data.localeCompare(a.data) || b.createdAt - a.createdAt);
    }

    function computeTotal(list){ return list.reduce((acc,i)=> acc + Number(i.valor||0), 0); }

    function el(tag, props={}, children=[]) {
      const e = document.createElement(tag);
      Object.assign(e, props);
      children.forEach(c => e.appendChild(c));
      return e;
    }

    function render(){
      const list = filtered();
      $('#total').textContent = fmt.format(computeTotal(list));
      $('#monthTitle').textContent = formatMonthTitle(state.month);
      const wrap = $('#lista'); wrap.innerHTML='';
      if(list.length===0){
        wrap.appendChild(el('div',{className:'empty',innerHTML:'Nada por aqui ainda. Adicione seu primeiro gasto.'}));
        return;
      }
      const tpl=$('#tpl-item');
      list.forEach(i=>{
        const node=tpl.content.firstElementChild.cloneNode(true);
        node.dataset.id=i.id;

        const amount=node.querySelector('.amount');
        amount.textContent=fmt.format(i.valor);
        amount.classList.toggle('paid', !!i.pago);

        node.querySelector('.date').textContent=new Date(i.data).toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'short'});
        node.querySelector('.info').textContent=i.nota||'—';

        const badge=node.querySelector('.categoria');
        badge.textContent=i.categoria||'sem categoria';
        badge.classList.toggle('paid', !!i.pago);

        node.querySelector('.del').addEventListener('click',()=>{ if(confirm('Apagar este gasto?')) remove(i.id); });
        node.querySelector('.edit').addEventListener('click',()=>openEditor(i));
        node.querySelector('.pay').addEventListener('click',()=>{
          i.pago = !i.pago;
          update(i.id, {pago:i.pago});
        });

        wrap.appendChild(node);
      });
    }

    function openEditor(item){
      state.editing=item.id;
      $('#editValor').value=item.valor;
      $('#editData').value=item.data;
      $('#editCategoria').value=item.categoria||'';
      $('#editNota').value=item.nota||'';
      $('#modalWrap').style.display='flex';
    }
    function closeEditor(){ state.editing=null; $('#modalWrap').style.display='none'; }

    function openAdd(){ $('#valor').value=''; $('#data').value=today(); $('#categoria').value=''; $('#nota').value=''; $('#modalAdd').style.display='flex'; }
    function closeAdd(){ $('#modalAdd').style.display='none'; }

    function wireControls(){
      $('#month').addEventListener('change', e=>{ state.month=e.target.value; render(); });
      $('#search').addEventListener('input', e=>{ state.search=e.target.value; render(); });
      $('#addBtn').addEventListener('click', openAdd);
      $('#cancelAdd').addEventListener('click', closeAdd);
      $('#saveAdd').addEventListener('click', ()=>{
        const valor=Number($('#valor').value);
        if(!Number.isFinite(valor)||valor<=0){alert('Valor inválido');return;}
        const data=$('#data').value||today();
        const categoria=$('#categoria').value.trim();
        const nota=$('#nota').value.trim();
        add({valor,data,categoria,nota,createdAt:Date.now(), pago:false});
        closeAdd();
      });

      $('#cancelEdit').addEventListener('click', closeEditor);
      $('#saveEdit').addEventListener('click', ()=>{
        if(!state.editing) return;
        const valor=Number($('#editValor').value);
        if(!Number.isFinite(valor)||valor<=0){alert('Valor inválido');return;}
        update(state.editing,{
          valor,
          data:$('#editData').value,
          categoria:$('#editCategoria').value,
          nota:$('#editNota').value
        });
        closeEditor();
      });
    }

    async function init(){
      setMonthFromNow();
      $('#data').value=today();
      wireControls();

      try {
        const snap=await getDocs(collection(dbFire,"gastos"));
        state.items=[];
        snap.forEach(docSnap=>{
          state.items.push({...docSnap.data(),id:docSnap.id});
        });
      } catch(e){ console.warn("Erro carregar nuvem",e); }

      render();
    }

    init();
  </script>
</body>
</html>
